<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Flappy Bird</title>
    <script src="sprite.js"></script>
    <script src="bird.js"></script>
    <script src="ground.js"></script>
    <script src="pipe.js"></script>
    <script src="ImageLibrary.js" charset="utf-8"></script>
    <script src="AudioLibrary.js" charset="utf-8"></script>
  </head>
  <body>
    <h1>Flappy Bird</h1>
    <canvas width="480" height="320"> //480,320
      Seu browser não suporta canvas!</canvas>
    <script>
    var tela = document.getElementsByTagName("canvas")[0];
    tela.style.border = '2px solid #000';                       //Colocando borda no canvas
    /*
    <canvas id="canvas" width="500" height="500" style="border: 1px solid black;">
    Your browser does not support the HTML 5 Canvas.
    </canvas>
    */
    var ctx = tela.getContext("2d");
    var imageLibrary = new ImageLibrary();
    imageLibrary.load("spriteSheet", "SpriteSheet.png");
    var audioLibrary = new AudioLibrary();
    //audioLibrary.load("tank-firing","Tank_Firing.mp3");
    var G = 500;          //G = 200;
    var dt = anterior = 0;
    var player = new Bird();
    var estado = 1;
    var melhorPontuacao = 0;
    var tempoGameOver = 5;
    var velFase = 200;


    //posicaoRandPlataforma = Math.floor(Math.random() * (tela.width - plataforma.w));

    //Elementos da fase

    /*chao.push(new Sprite());
    chao[0].wImagem = 168;
    chao[0].hImagem = 56;
    chao[0].sx = 292;
    chao[0].sy = 0;
    chao[0].x = 0;
    chao[0].y = tela.height-56;
    chao[0].w = tela.width+15;
    chao[0].h = 56;
    chao.push(new Sprite());
    chao[1].wImagem = 168;
    chao[1].hImagem = 56;
    chao[1].sx = 292;
    chao[1].sy = 0;
    chao[1].x = chao[0].x + chao[0].w-2;
    chao[1].y = tela.height-56;
    chao[1].w = tela.width+15;
    chao[1].h = 56;*/

    var chao = new Ground(tela);
    /*chao.push(new Ground());
    chao[0].sprite.x = 0;
    chao[0].sprite.y = tela.height-56;
    chao[0].sprite.w = tela.width+15;
    chao[0].sprite.h = 56;
    chao.push(new Ground());
    chao[1].sprite.x = chao[0].sprite.x + chao[0].sprite.w-2;
    chao[1].sprite.y = tela.height-56;
    chao[1].sprite.w = tela.width+15;
    chao[1].sprite.h = 56;*/

    //
    //imageLibrary.drawClipSize(ctx, "spriteSheet", 292, 0, 168, 56, 0, tela.height-56, tela.width, 56);    //chão

    var barreira = [];
    barreira.push(new Pipe());
    barreira[0].testePosicionamento(200);

    var maxY = 160;
    var minY = 40;
    var espEntreBarreiras = 250;
    var distEntreCanos = 80;
    var atingiuPontos = false;                  //A cada 15 pontos o esp Entre Barreiras diminui 10 até chegar a 60

    //Main Menu campos
    var fontMainMenu = "30px Arial Black";
    var wordsColor = "white";
    var alignMainMenu = "center";
    var stateMainMenu = 0;

    /**************************************************
      *           Estados:
      * 0 - Venceu;         //Pousou no ponto certo e com energia e será iniciada uma nova fase
      * 1 - Repara elementos;//Ajusta determinados elementos do jogo, como pontos e posições de elementos
      * 2 - Jogando;        //Durante a partida
      * 3 - Menu;           //Main menu tem duas opções: "new game" e "quit";
      * 4 - Game over;      //Exibe uma mensagem de game over na tela
      * 5 - Fechado;        //Tela preta
      ***************************************************/


    function passo(t) {
      dt = (t - anterior)/1000;
      if(imageLibrary.loaded+audioLibrary.loaded<imageLibrary.size+audioLibrary.size) {//if(il.loaded+al.loaded<il.size+al.size) {
        //ctx.fillStyle = "white";
        //ctx.fillText("Carregando imagens e audio... "+(100*(il.loaded+al.loaded)/(il.size+al.loaded)).toFixed(2)+"%", 20, 100);
        console.log("Carregando imagens e audio... "+(100*(imageLibrary.loaded+audioLibrary.loaded)/(imageLibrary.size+audioLibrary.size)).toFixed(2)+"%", 20, 100);
        console.log("Não terminou de carregar...");
        //return;
      }
      else{
        switch (estado) {
          case 0:
            //posicaoRandPlataforma = Math.floor(Math.random() * (tela.width - plataforma.w));
            //player.pontos = player.pontos + 100 + Math.ceil(player.energia);

            estado = 1;

            break;
          case 1:
            player.x = tela.width/2 -15;
            player.y = player.h;

            estado = 2;
            break;
          case 2:
            //limparTela();
            imageLibrary.drawClipSize(ctx, "spriteSheet", 0, 0, 144, 223, 0, 0, tela.width, tela.height-56);      //Background
            //imageLibrary.drawClipSize(ctx, "spriteSheet", 292, 0, 168, 56, 0, tela.height-56, tela.width, 56);    //chão

            //barreira[0].mover(dt);
            //barreira[0].desenhar(ctx);
            chao.mover(dt, velFase);
            for(var i = 0; i < barreira.length;i++){
              if(barreira[i].sprite[0].x + barreira[i].sprite[0].w <= 0){
                barreira.splice(i, 1);
              }
              else{
                barreira[i].mover(dt);
              }
            }
            if(barreira.length != 0){
              if(tela.width - (barreira[barreira.length-1].sprite[0].x + barreira[barreira.length-1].sprite[0].w) >= espEntreBarreiras){
                criarBarreira();
              }
            }
            else{
              criarBarreira();
            }
            player.mover(dt);
            player.impoeLimites(0, 0, tela.width, tela.height-56);        //Até o chão

            for(var i = 0; i < barreira.length;i++){
              barreira[i].desenhar(ctx);
            }
            chao.desenhar(ctx);
            player.desenhar(ctx);
            ctx.font = "20px Arial Black";
            ctx.fillStyle = "white";
            ctx.textAlign = alignMainMenu;
            ctx.lineWidth = 2;
            ctx.strokeStyle = "black";
            ctx.strokeText("Pontos: ", tela.width - 120,20);
            ctx.fillText("Pontos: ", tela.width - 120,20);
            ctx.strokeText(player.pontos, tela.width - 50, 20);
            ctx.fillText(player.pontos, tela.width - 50, 20);
            break;
          case 3:         //Main menu
            //limparTela();
            //imageLibrary.drawClipSize(ctx, "spriteSheet", 0, 0, 144, 223, 0, 0, tela.width, tela.height);
            imageLibrary.drawClipSize(ctx, "spriteSheet", 0, 0, 144, 223, 0, 0, tela.width, tela.height-56);      //Background
            imageLibrary.drawClipSize(ctx, "spriteSheet", 292, 0, 168, 56, 0, tela.height-56, tela.width, 56);    //chão
            ctx.fillStyle = wordsColor;
            ctx.textAlign = alignMainMenu;
            ctx.lineWidth = 2;
            ctx.strokeStyle = "black";
            ctx.font = "40px Arial Black";
            ctx.strokeText("Flappy Bird", tela.width/2, tela.height/3);
            ctx.fillText("Flappy Bird", tela.width/2, tela.height/3);
            ctx.font = "15px Arial Black";
            ctx.strokeText("Hi-Score: "+ melhorPontuacao,  tela.width/2, tela.height/2 + tela.height/3 + 30);
            ctx.fillText("Hi-Score: "+ melhorPontuacao,  tela.width/2, tela.height/2 + tela.height/3 + 30);
            ctx.font = fontMainMenu;
            if(stateMainMenu == 0){
              ctx.fillStyle = "blue";
              ctx.strokeText("New Game", tela.width/2, tela.height/2 + tela.height/4-15);
              ctx.fillText("New Game", tela.width/2, tela.height/2 + tela.height/4-15);
              ctx.fillStyle = wordsColor;
              ctx.strokeText("Quit", tela.width/2, tela.height/2 + tela.height/3);
              ctx.fillText("Quit", tela.width/2, tela.height/2 + tela.height/3);
            }
            else{
              ctx.fillStyle = wordsColor;
              ctx.strokeText("New Game", tela.width/2, tela.height/2 + tela.height/4-15);
              ctx.fillText("New Game", tela.width/2, tela.height/2 + tela.height/4-15);
              ctx.fillStyle = "blue";
              ctx.strokeText("Quit", tela.width/2, tela.height/2 + tela.height/3);
              ctx.fillText("Quit", tela.width/2, tela.height/2 + tela.height/3);
            }

            break;
          case 4:
            //limparTela();
            ctx.fillStyle = "white";
            ctx.textAlign = alignMainMenu;
            ctx.font = "40px Arial Black";
            ctx.fillText("GAME OVER", tela.width/2, tela.height/2);
            if(tempoGameOver >= 0){
                tempoGameOver = tempoGameOver - 0.7*dt;
            }
            else{
                estado = 3;
            }

            break;
          case 5:
            //limparTela();
            imageLibrary.drawClipSize(ctx, "spriteSheet", 0, 0, 144, 223, 0, 0, tela.width, tela.height-56);      //Background
            imageLibrary.drawClipSize(ctx, "spriteSheet", 292, 0, 168, 56, 0, tela.height-56, tela.width, 56);    //chão
            break;
          default:

        }
      }
      anterior = t;
      requestAnimationFrame(passo);
    }

    requestAnimationFrame(passo);

    function limparTela() {
      ctx.fillStyle = "rgb(10,110,155)";
      ctx.fillRect(0,0, tela.width, tela.height);
    }

    function criarBarreira(){
      var y = getRandomArbitrary(minY, maxY);
      var canos = new Pipe();
      canos.alteraYInicioEntreCanos(y);
      canos.alteraDistCanos(distEntreCanos);
      canos.alteraXCanos(tela.width+10);
      barreira.push(canos);
    }

    function getRandomArbitrary(min, max){
      return Math.floor(Math.random()*(max - min)) + min;                     //Seleciona um valor entre o min e o max
    }

    addEventListener("keydown", function(e){
      console.log(e.keyCode);
      if (estado != 3) {
        //if(tempoInicioPartida <= 0){
          switch (e.keyCode) {
            case 38:
              //player.ay = -3000;
              player.sprite.vy = -200;
              break;
            case 27:      //Pressionar o Esq
              stateMainMenu = 0;
              estado = 3;
              break;
            default:
          }
        //}
      }
      else{
        switch (e.keyCode) {
          case 13:    //Enter
            if(stateMainMenu == 0){
              estado = 1;
            }
            else{
              estado = 5;
            }
            break;
          case 32:         //Space bar
            if(stateMainMenu == 0){
              estado = 1;
            }
            else{
              estado = 5;
            }
            break;
          case 38:
            if(stateMainMenu == 1){
              stateMainMenu = 0;
            }
            break;
          case 40:
            if(stateMainMenu == 0){
              stateMainMenu = 1;
            }
            break;
          case 27:      //Pressionar o Esq
            stateMainMenu = 0;
            estado = 3;
            break;
          default:

        }
      }

    });
    addEventListener("keyup", function(e){
      switch (e.keyCode) {
        case 37:
        case 39:
          player.sprite.ax = 0;
          break;
        case 38:
        case 40:
          player.sprite.ay = 0;
          break;
        default:
      }
    });

    </script>
  </body>
</html>
